# CodeReview Agent GitHub Action

name: CodeReview Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number'
        required: false
        type: string
      refresh:
        description: 'Force refresh cache'
        required: false
        type: boolean
        default: false

jobs:
  codereview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv pip install --system -e ./python

      - name: Get PR diff
        if: github.event_name == 'pull_request'
        id: diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the diff between base and head
          PR_NUMBER=${{ github.event.pull_request.number }}
          DIFF=$(gh pr diff $PR_NUMBER --json files,additions,deletions)
          
          # Convert to JSON format for CLI
          echo "$DIFF" > pr-diff.json
          
          # Also get patch for each file
          echo "::set-output name=diff_file::pr-diff.json"
          echo "::set-output name=pr_number::$PR_NUMBER"

      - name: Run CodeReview Agent
        id: review
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR number
          PR_NUMBER=${{ github.event.pull_request.number || github.inputs.pr_number }}
          
          # Run the review
          cd ${{ github.workspace }}
          
          # Build diff JSON from gh cli
          FILES_JSON=$(gh pr view $PR_NUMBER --json files -q '.files[] | {filename: .path, status: .changeStatus, additions: .additions, deletions: .deletions}')
          
          # Run CLI
          python -m codereview.cli \
            --pr $PR_NUMBER \
            --diff "{\"files\": $FILES_JSON}" \
            --config .codereview-agent.yaml \
            --json > review-result.json || true
          
          # Extract PR comment
          PR_COMMENT=$(cat review-result.json | jq -r '.outputs.pr_comment // empty')
          
          if [ -n "$PR_COMMENT" ]; then
            echo "$PR_COMMENT" > pr-comment.md
          fi

      - name: Post PR comment
        if: steps.review.outputs.success != 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr-comment.md', 'utf8');
            
            if (comment.trim()) {
              // Find existing comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              });
              
              const existingComment = comments.find(c => 
                c.user.type === 'Bot' && c.body.includes('CodeReview Agent')
              );
              
              if (existingComment) {
                // Update existing
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
              } else {
                // Create new
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: comment
                });
              }
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload review report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report
          path: |
            .codereview-agent/output/
            review-result.json
          retention-days: 30
